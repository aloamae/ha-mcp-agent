# ========================================
# DASHBOARD DE DEBUGGING - MODES CHAUFFAGE & CLIMATISATIONS
# ========================================
#
# Ce dashboard permet de:
# - Visualiser l'ordre de priorit√© des modes
# - D√©bugger les climatisations Broadlink
# - V√©rifier le mode_chauffage_global
# - Tester le mode pr√©sence
# - Analyser les logs en temps r√©el
#
# Installation:
# Param√®tres ‚Üí Tableaux de bord ‚Üí + ‚Üí Copier ce YAML
#
# ========================================

title: "üîß Debugging Modes Chauffage"
path: debugging-modes
icon: mdi:bug
badges: []

cards:
  # ========================================
  # SECTION 1: VUE D'ENSEMBLE PRIORIT√âS
  # ========================================
  - type: vertical-stack
    cards:
      - type: markdown
        content: |
          # üéØ ORDRE DE PRIORIT√â DES MODES

          ```
          1Ô∏è‚É£ MODE VACANCES (Priorit√© MAX)
             ‚îî‚îÄ> input_boolean.mode_vacance
             ‚îî‚îÄ> Consigne: 16¬∞C (hors-gel)
             ‚îî‚îÄ> BLOQUE tous les autres modes

          2Ô∏è‚É£ MODE MANUEL PAR PI√àCE
             ‚îî‚îÄ> input_select.mode_chauffage_salon
             ‚îî‚îÄ> input_select.mode_chauffage_cuisine
             ‚îî‚îÄ> input_select.mode_chauffage_parents (?)
             ‚îî‚îÄ> Override: planning + global

          3Ô∏è‚É£ MODE PR√âSENCE
             ‚îî‚îÄ> zone.home
             ‚îî‚îÄ> D√©part: Sauvegarde + Absent
             ‚îî‚îÄ> Retour: Restauration
             ‚îî‚îÄ> INCOMPLET: automation retour cr√©√©e

          4Ô∏è‚É£ MODE PLANNING HORAIRE (4x/jour)
             ‚îî‚îÄ> Matin, Midi, Apr√®s-midi, Soir
             ‚îî‚îÄ> D√©finit consignes selon heure

          5Ô∏è‚É£ MODE CHAUFFAGE GLOBAL
             ‚îî‚îÄ> sensor.mode_chauffage_global
             ‚îî‚îÄ> Consigne par d√©faut
             ‚îî‚îÄ> Fallback: 18.5¬∞C

          6Ô∏è‚É£ PILOTAGE CHAUDI√àRE (Ex√©cution)
             ‚îî‚îÄ> automation.chauffage_pilotage_chaudiere_gaz
             ‚îî‚îÄ> Seuils: ¬±0.5¬∞C
             ‚îî‚îÄ> Zone morte: Maintien √©tat
             ‚îî‚îÄ> Cycle: Toutes les 3 min
          ```

      - type: entities
        title: "üéöÔ∏è √âTAT DES MODES (Priorit√© d√©croissante)"
        show_header_toggle: false
        entities:
          # Priorit√© 1
          - type: section
            label: "1Ô∏è‚É£ MODE VACANCES (Max)"
          - entity: input_boolean.mode_vacance
            name: Mode Vacances
            icon: mdi:beach
          - type: conditional
            conditions:
              - entity: input_boolean.mode_vacance
                state: "on"
            row:
              type: custom:template-entity-row
              name: "‚ö†Ô∏è Consigne forc√©e"
              state: "16¬∞C (hors-gel)"
              icon: mdi:snowflake-alert

          # Priorit√© 2
          - type: section
            label: "2Ô∏è‚É£ MODES MANUELS PAR PI√àCE"
          - entity: input_select.mode_chauffage_salon
            name: Mode Salon
            icon: mdi:sofa
          - entity: input_select.mode_chauffage_cuisine
            name: Mode Cuisine
            icon: mdi:silverware-fork-knife

          # Priorit√© 3
          - type: section
            label: "3Ô∏è‚É£ MODE PR√âSENCE"
          - entity: zone.home
            name: Personnes √† la maison
            icon: mdi:home-account
          - entity: automation.mode_presence_depart
            name: "Automation d√©part"
          - entity: automation.mode_presence_retour
            name: "Automation retour (NOUVEAU)"
          - type: button
            name: "Tester sauvegarde"
            action_name: "Cr√©er scene"
            tap_action:
              action: call-service
              service: scene.create
              service_data:
                scene_id: avant_depart
                snapshot_entities:
                  - input_select.mode_chauffage_salon
                  - input_select.mode_chauffage_cuisine

          # Priorit√© 4
          - type: section
            label: "4Ô∏è‚É£ PLANNING HORAIRE"
          - entity: automation.chauffage_planning_matin
            name: Planning Matin
          - entity: automation.chauffage_planning_midi
            name: Planning Midi
          - entity: automation.chauffage_planning_apres_midi
            name: Planning Apr√®s-midi
          - entity: automation.chauffage_planning_soir
            name: Planning Soir

          # Priorit√© 5
          - type: section
            label: "5Ô∏è‚É£ MODE CHAUFFAGE GLOBAL"
          - entity: sensor.mode_chauffage_global
            name: Consigne globale active
            icon: mdi:thermometer

          # Priorit√© 6
          - type: section
            label: "6Ô∏è‚É£ EX√âCUTION CHAUDI√àRE"
          - entity: automation.chauffage_pilotage_chaudiere_gaz
            name: Pilotage chaudi√®re
          - entity: switch.thermostat
            name: √âtat chaudi√®re
            icon: mdi:fire

  # ========================================
  # SECTION 2: TEMP√âRATURES EN TEMPS R√âEL
  # ========================================
  - type: vertical-stack
    cards:
      - type: markdown
        content: |
          # üå°Ô∏è TEMP√âRATURES & CONSIGNES

      - type: entities
        title: "Temp√©ratures actuelles"
        entities:
          - entity: sensor.th_cuisine_temperature
            name: Cuisine
            icon: mdi:thermometer
          - entity: sensor.th_parents_temperature
            name: Parents
            icon: mdi:thermometer
          - entity: sensor.th_loann_temperature
            name: Loann
            icon: mdi:thermometer

          - type: section
            label: "Consigne active"
          - type: conditional
            conditions:
              - entity: input_boolean.mode_vacance
                state: "on"
            row:
              type: custom:template-entity-row
              name: "Mode Vacances"
              state: "16¬∞C"
              icon: mdi:snowflake
          - type: conditional
            conditions:
              - entity: input_boolean.mode_vacance
                state: "off"
            row:
              entity: sensor.mode_chauffage_global
              name: "Mode Normal"
              icon: mdi:target

      - type: custom:apexcharts-card
        header:
          show: true
          title: "√âvolution temp√©ratures (24h)"
        graph_span: 24h
        series:
          - entity: sensor.th_cuisine_temperature
            name: Cuisine
            color: '#FF6384'
          - entity: sensor.th_parents_temperature
            name: Parents
            color: '#36A2EB'
          - entity: sensor.th_loann_temperature
            name: Loann
            color: '#FFCE56'

  # ========================================
  # SECTION 3: CLIMATISATIONS BROADLINK
  # ========================================
  - type: vertical-stack
    cards:
      - type: markdown
        content: |
          # ‚ùÑÔ∏è CLIMATISATIONS BROADLINK

          **Statut:** SmartIR install√© mais **AUCUNE automation**

      - type: entities
        title: "√âtat des remotes Broadlink"
        show_header_toggle: false
        entities:
          - entity: remote.clim_salon
            name: "Remote Salon"
            icon: mdi:remote
          - entity: remote.clim_maeva
            name: "Remote Maeva"
            icon: mdi:remote
          - entity: remote.clim_axel
            name: "Remote Axel"
            icon: mdi:remote

          - type: section
            label: "‚ö†Ô∏è Actions rapides"
          - type: button
            name: "Activer tous les remotes"
            icon: mdi:power
            action_name: "ON"
            tap_action:
              action: call-service
              service: homeassistant.turn_on
              service_data:
                entity_id:
                  - remote.clim_salon
                  - remote.clim_maeva
                  - remote.clim_axel

      - type: entities
        title: "√âtat des climatisations"
        entities:
          - entity: climate.climatisation_salon
            name: Climatisation Salon
          - entity: climate.climatisation_maeva
            name: Climatisation Maeva
          - entity: climate.climatisation_axel
            name: Climatisation Axel

      - type: horizontal-stack
        cards:
          - type: tile
            entity: climate.climatisation_salon
            name: Salon
            features:
              - type: climate-hvac-modes
                hvac_modes:
                  - "off"
                  - heat
                  - cool
              - type: climate-fan-modes
                style: dropdown

          - type: tile
            entity: climate.climatisation_maeva
            name: Maeva
            features:
              - type: climate-hvac-modes
                hvac_modes:
                  - "off"
                  - heat
                  - cool
              - type: climate-fan-modes
                style: dropdown

          - type: tile
            entity: climate.climatisation_axel
            name: Axel
            features:
              - type: climate-hvac-modes
                hvac_modes:
                  - "off"
                  - heat
                  - cool
              - type: climate-fan-modes
                style: dropdown

      - type: markdown
        content: |
          ### üîß Tests manuels

          **Si les climatisations ne r√©pondent pas:**

          1. **V√©rifier remotes ON** (ci-dessus)
          2. **Tester manuellement:**
             - Outils dev ‚Üí Services
             - Service: `climate.turn_on`
             - Entit√©: `climate.climatisation_salon`
             - Appeler le service
             - Observer: LED Broadlink clignote?
          3. **V√©rifier logs:**
             - Outils dev ‚Üí Logs
             - Chercher: "smartir" ou "broadlink"

          **Probl√®mes fr√©quents:**
          - ‚ùå Remote OFF ‚Üí Cliquer bouton "Activer" ci-dessus
          - ‚ùå SmartIR obsol√®te ‚Üí Mettre √† jour via HACS
          - ‚ùå Broadlink d√©connect√© ‚Üí V√©rifier IP r√©seau
          - ‚ùå Code IR invalide ‚Üí V√©rifier device_code

  # ========================================
  # SECTION 4: SENSOR MODE_CHAUFFAGE_GLOBAL
  # ========================================
  - type: vertical-stack
    cards:
      - type: markdown
        content: |
          # üéØ SENSOR MODE_CHAUFFAGE_GLOBAL

          **Utilisation:** Consigne par d√©faut (fallback 18.5¬∞C)

      - type: entities
        title: "Analyse sensor.mode_chauffage_global"
        entities:
          - entity: sensor.mode_chauffage_global
            name: Valeur actuelle
            icon: mdi:thermometer
          - type: attribute
            entity: sensor.mode_chauffage_global
            attribute: friendly_name
            name: Nom
          - type: attribute
            entity: sensor.mode_chauffage_global
            attribute: device_class
            name: Device Class
          - type: attribute
            entity: sensor.mode_chauffage_global
            attribute: unit_of_measurement
            name: Unit√©

      - type: markdown
        content: |
          ### ‚ùì √Ä v√©rifier

          **Ce sensor est probablement:**
          - Template sensor (configuration.yaml)
          - OU Helper (Param√®tres ‚Üí Auxiliaires)

          **Logique suppos√©e:**
          ```
          SI mode_manuel_actif ALORS
            ‚Üí Consigne mode manuel
          SINON SI planning_actif ALORS
            ‚Üí Consigne planning horaire
          SINON
            ‚Üí Consigne par d√©faut (18.5¬∞C)
          ```

          **Comment le trouver:**
          1. Param√®tres ‚Üí Auxiliaires ‚Üí Chercher "mode chauffage"
          2. OU v√©rifier `configuration.yaml`:
             ```yaml
             template:
               - sensor:
                   - name: "Mode Chauffage Global"
                     state: >
                       {% if ... %}
             ```

  # ========================================
  # SECTION 5: LOGS EN TEMPS R√âEL
  # ========================================
  - type: vertical-stack
    cards:
      - type: markdown
        content: |
          # üìä LOGS CHAUFFAGE

      - type: logbook
        entities:
          - automation.chauffage_pilotage_chaudiere_gaz
          - switch.thermostat
          - automation.mode_presence_depart
          - automation.mode_presence_retour
          - zone.home
          - input_boolean.mode_vacance
        hours_to_show: 6

      - type: entities
        title: "Journal Chauffage (derniers messages)"
        entities:
          - entity: sensor.journal_chauffage
            name: Dernier log
            icon: mdi:text-box

      - type: markdown
        content: |
          ### üîç Chercher dans les logs

          **Outils dev ‚Üí Logs ‚Üí Chercher:**
          - `ZONE MORTE` ‚Üí Maintien √©tat
          - `ALLUMAGE` ‚Üí Chaudi√®re d√©marre
          - `EXTINCTION` ‚Üí Chaudi√®re s'√©teint
          - `smartir` ‚Üí Climatisations
          - `broadlink` ‚Üí Remotes IR

  # ========================================
  # SECTION 6: TESTS & DIAGNOSTICS
  # ========================================
  - type: vertical-stack
    cards:
      - type: markdown
        content: |
          # üß™ TESTS RAPIDES

      - type: entities
        title: "Actions de test"
        show_header_toggle: false
        entities:
          - type: button
            name: "Ex√©cuter automation chaudi√®re"
            icon: mdi:play
            action_name: "RUN"
            tap_action:
              action: call-service
              service: automation.trigger
              service_data:
                entity_id: automation.chauffage_pilotage_chaudiere_gaz

          - type: button
            name: "Activer mode vacances (test)"
            icon: mdi:beach
            action_name: "ON"
            tap_action:
              action: call-service
              service: input_boolean.turn_on
              service_data:
                entity_id: input_boolean.mode_vacance

          - type: button
            name: "D√©sactiver mode vacances"
            icon: mdi:close
            action_name: "OFF"
            tap_action:
              action: call-service
              service: input_boolean.turn_off
              service_data:
                entity_id: input_boolean.mode_vacance

          - type: button
            name: "Sauvegarder √©tat actuel (sc√®ne)"
            icon: mdi:content-save
            action_name: "SAVE"
            tap_action:
              action: call-service
              service: scene.create
              service_data:
                scene_id: avant_depart
                snapshot_entities:
                  - input_select.mode_chauffage_salon
                  - input_select.mode_chauffage_cuisine

          - type: button
            name: "Restaurer √©tat sauvegard√©"
            icon: mdi:restore
            action_name: "RESTORE"
            tap_action:
              action: call-service
              service: scene.turn_on
              service_data:
                entity_id: scene.avant_depart

          - type: button
            name: "Test climatisation Salon"
            icon: mdi:air-conditioner
            action_name: "TEST"
            tap_action:
              action: call-service
              service: climate.turn_on
              service_data:
                entity_id: climate.climatisation_salon

      - type: markdown
        content: |
          ### ‚úÖ V√©rifications syst√®me

          **Checklist quotidienne:**
          - [ ] Automation chaudi√®re activ√©e (ON)
          - [ ] Logs toutes les 3 minutes
          - [ ] Remotes Broadlink activ√©s (ON)
          - [ ] Mode vacances d√©sactiv√© (sauf vacances)
          - [ ] Temp√©ratures coh√©rentes (¬±2¬∞C)
          - [ ] Chaudi√®re r√©agit aux commandes

  # ========================================
  # SECTION 7: DOCUMENTATION
  # ========================================
  - type: markdown
    content: |
      # üìö DOCUMENTATION SYST√àME

      ## Fichiers cr√©√©s

      - `automation_chauffage_pilotage_chaudiere_corrigee.yaml`
        ‚Üí Pilotage chaudi√®re (seuils ¬±0.5¬∞C)

      - `automation_mode_presence_retour.yaml`
        ‚Üí Retour √† la maison (NOUVEAU)

      - `REPONSE_COMPLETE_QUESTIONS_CHAUFFAGE.md`
        ‚Üí Analyse compl√®te syst√®me

      - `ANALYSE_MODE_PRESENCE.md`
        ‚Üí D√©tails mode pr√©sence

      - `GUIDE_ORDRE_PRIORITE_CHAUFFAGE.md`
        ‚Üí Guide des priorit√©s

      - `dashboard_debugging_modes_complet.yaml`
        ‚Üí Ce dashboard

      ## Guides d'installation

      - `INSTALLATION_RAPIDE_AUTOMATION.md`
      - `GUIDE_INSTALLATION_AUTOMATION_CORRIGEE.md`
      - `installer_automation_corrigee_clean.ps1`

      ## Scripts PowerShell

      - `analyser_modes_chauffage.ps1`
      - `analyser_climatisations.ps1`
      - `get_climate_modes.ps1`

      ---

      **Derni√®re mise √† jour:** 20 d√©cembre 2025
      **Statut:** ‚úÖ Chaudi√®re OK | ‚ùå Climatisations sans auto
